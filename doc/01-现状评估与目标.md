# 01 现状评估与目标

## 1. 评估结论（摘要）

当前项目具备较强的二次开发基础：

- 主线程与 Worker 分工清晰，渲染主链路完整；
- 图层/数据源能力丰富，扩展机制可用；
- CI、构建、测试体系较完善。

同时存在影响二次开发效率的关键问题：

- 核心类（如 Map/Style）体量过大、职责偏多；
- 模块间耦合高，边界可演进但不够清晰；
- 类型严格性与工程基线仍有提升空间；
- 架构文档与代码现状存在差距。

## 2. 核心现状

### 2.1 架构与运行链路

- 渲染驱动：`Map._update/_render` -> `Style.update` -> `TileManager.update` -> `Painter.render`。
- 渲染策略：offscreen/opaque/translucent 多 pass，支持 terrain 的 render-to-texture。
- 数据链路：source -> worker parse/layout -> bucket upload -> draw。

### 2.2 代码质量与工程基线

- 优点：ESLint + TypeCheck + 多套测试（unit/integration/render/build）+ 覆盖率汇总。
- 风险：
  - 主配置 `tsconfig.json` 为 `strict: false`；
  - 一些核心文件存在较多 `any`；
  - 架构说明文档不完整。

### 2.3 本地执行基线（建议作为首批修复项）

- `npm run typecheck`：通过。
- `npm run build-dev`：通过。
- `npm run lint -- --max-warnings=0`：失败（demo 文件风格规则问题）。
- `npm run test-unit`：失败（本地 Node 版本/依赖兼容问题导致 worker 启动异常）。

## 3. 二次开发目标

### 3.1 业务目标

- 在不破坏现有 API 的前提下，支持更高效的功能扩展（overlay、数据源、可视化能力）。
- 建立可复用的模块化开发方式，降低“改一处牵一片”的风险。

### 3.2 技术目标

- 完成核心模块边界重塑：运行时、样式引擎、数据流水线、渲染引擎、扩展 SDK。
- 建立统一接口契约，减少隐式耦合。
- 技术债治理进入持续机制，而非一次性运动。

### 3.3 交付目标

- 形成可执行路线图（12~16 周）；
- 每阶段可独立验收，具备回滚策略；
- 发布过程可灰度、可观测、可追溯。

## 4. 范围定义

### 4.1 In Scope

- 架构分层与模块解耦；
- 接口规范与扩展机制标准化；
- 技术债治理（类型、测试、文档、可维护性）；
- 性能专项与兼容策略。

### 4.2 Out of Scope（首期）

- 大规模 API 破坏性重写；
- 无明确业务收益的底层重构；
- 与当前路线不一致的渲染范式替换。

## 5. 成功指标（第一阶段）

- 质量基线：lint/typecheck/unit 可稳定运行；
- 工程基线：核心模块有明确边界与 Owner；
- 交付基线：每个里程碑都有 DoD（Definition of Done）；
- 风险基线：高风险项均有监控指标与回滚预案。

## 6. 依赖关系

- 详细模块边界见：`02-目标架构与模块边界.md`
- 接口规范见：`03-接口定义与扩展规范.md`
- 路线与节奏见：`07-开发路线图与里程碑.md`
