# 05 性能优化专项方案

## 1. 目标

- 在功能扩展同时保持渲染稳定性与交互流畅性；
- 建立性能优化的“指标 -> 分析 -> 改造 -> 回归”闭环。

## 2. 指标体系（建议）

## 2.1 用户可感知指标

- 首次可交互时间（TTI）
- 首屏稳定时间（Full Load）
- 平均 FPS / 低端设备 FPS
- 交互期间卡顿率（长帧占比）

## 2.2 引擎内部指标

- 帧内各阶段耗时（style/source/placement/render）
- worker 任务队列等待时间
- tile 上传与纹理切换次数
- draw call 与 program 切换次数

## 2.3 资源指标

- 内存峰值与增长速率
- tile cache 命中率
- 图集（glyph/image）更新频率

## 3. 基线采集方法

- 建立固定场景集：
  - 高频缩放/旋转
  - 大量点/线图层
  - terrain + globe
  - 弱网 tile 请求
- 同一硬件环境重复采样，输出中位数与 P95。
- 每次优化前后必须出对比报告。

## 4. 优化工作流

```text
定位瓶颈 -> 设计改造 -> 小步提交 -> 指标回归 -> 决策保留/回滚
```

## 5. 优化方向建议

### 5.1 调度与数据

- 减少无效 `update` 传播；
- 优化 tile retain/reload 触发条件；
- worker 并发策略按设备能力调优。

### 5.2 渲染路径

- 减少 pass 内状态切换与 program 抖动；
- 控制纹理切换与 draw call；
- terrain RTT 做变更驱动更新。

### 5.3 IO 与资源

- 调优并发请求上限与请求优先级；
- 优化图集 patch 策略；
- 强化缓存策略（tile/image/glyph）。

## 6. 验收标准（示例）

- 基准场景平均 FPS 提升 >= 10%；
- 长帧比例下降 >= 20%；
- full load 时间下降 >= 15%；
- 未引入兼容性回归。

## 7. 工具与产物

- 基准脚本 + 报告模板（见 `09`）；
- 每个优化项必须提交：
  - 变更说明
  - 指标对比图
  - 风险与回滚点

## 8. 关联文档

- 技术债治理：`04-技术债治理计划.md`
- 兼容发布：`06-向后兼容与发布策略.md`
- 风险台账：`08-风险清单与应对.md`
