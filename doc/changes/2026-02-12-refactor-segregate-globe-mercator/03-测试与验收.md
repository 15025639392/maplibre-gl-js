# 03 测试与验收

## 1. 测试范围

- strict 模式下投影链路稳定性验证
- legacy-hybrid 与 strict 行为差异验证
- `setProjection` 显式切换行为验证
- Map 事件语义与触发时机验证
- 性能与稳定性回归验证

## 2. 复现步骤（Bug 场景可填）

现状问题复现（作为对照基线）：

1. 设置 `projection: 'globe'`
2. 在临界缩放区间连续缩放与拖拽
3. 观察渲染与交互细节在内部过渡点附近变化
4. 对照 strict 模式应保持同一投影链路行为

## 3. 用例设计

### 3.1 功能用例

- C-FUNC-01：`projection: 'globe'` 下 `activeProjection` 全程为 globe
- C-FUNC-02：`projection: 'mercator'` 下 `activeProjection` 全程为 mercator
- C-FUNC-03：调用 `setProjection('mercator')` 仅触发一次显式切换
- C-FUNC-04：调用 `setProjection('globe')` 后不再出现内部自动切换
- C-FUNC-05：strict 与 legacy-hybrid 由开关控制可切换

### 3.2 回归用例

- C-REG-01：地图缩放、拖拽、旋转基础交互回归
- C-REG-02：地形、标注、弹窗在两类投影下行为回归
- C-REG-03：样式切换与投影切换叠加场景回归
- C-REG-04：离屏渲染与拾取查询结果回归

### 3.3 边界与异常用例

- C-BND-01：高频缩放穿越历史临界区间（连续 200 次）
- C-BND-02：快速连续调用 `setProjection` 的时序一致性
- C-BND-03：地图 resize 与投影切换并发场景
- C-BND-04：WebGL context lost/restored 后投影状态一致性

## 4. 执行记录

| 用例ID | 描述 | 结果 | 备注 |
| --- | --- | --- | --- |
| C-FUNC-01 | globe 严格单链路验证 | pass | 2026-02-15 strict 模式下 factory 返回纯 VP 三件套，transitionState=1 恒成立，18 项单测通过 |
| C-FUNC-02 | mercator 严格单链路验证 | pass | 2026-02-15 strict 模式下 mercator 创建路径不变，纯 Mercator 三件套 |
| C-FUNC-03 | 显式切换事件验证 | pending | 需集成测试验证 setProjection 触发 projectiontransition |
| C-FUNC-05 | strict 与 legacy-hybrid 由开关控制可切换 | pass | 2026-02-15 setProjectionSegregationMode('strict'/'legacy-hybrid') 可切换行为，单测 18/18 通过 |
| C-REG-01 | 基础交互回归 | pass | 2026-02-15 全部 160 项 projection 测试通过（含 globe_transform 50 项、mercator_transform 33 项等） |
| C-BND-01 | 临界区间高频缩放稳定性 | pending | 需运行时验证 |
| C-CODE-01 | projection_factory strict 分支代码走查 | pass | 2026-02-15 strict 下 'globe' 直接返回 VP 三件套 |
| C-CODE-02 | globe_projection strict 模式 transitionState 固定 | pass | 2026-02-15 strict 下 transitionState 恒为 1 |
| C-CODE-03 | globe_transform strict 模式 _globeness 固定 | pass | 2026-02-15 strict 下 setTransitionState 强制 globeness=1 |
| C-CODE-04 | globe_camera_helper strict 模式 useGlobeControls 固定 | pass | 2026-02-15 strict 下 useGlobeControls 恒为 true |
| C-CODE-05 | map.ts 渲染循环 strict 模式跳过过渡检测 | pass | 2026-02-15 strict 下 globeRenderingChanged=false |
| C-RUN-01 | 全量 projection 单测回归 | pass | 2026-02-15 vitest run src/geo/projection/ — 160/160 通过，0 失败 |

## 5. 性能验证（如适用）

目标阈值（strict 相对当前基线）：

- 渲染主循环耗时 P95：不高于基线 +3%
- 缩放交互卡顿率：不高于基线
- 内存占用峰值：不高于基线 +5%

对比维度：

- strict vs legacy-hybrid
- globe 场景 vs mercator 场景
- 普通缩放 vs 高频缩放场景

预评估结论（2026-02-15 代码层面）：

- strict 模式下 `'globe'` 创建纯 VP 三件套，省去 `GlobeProjection`/`GlobeTransform`/`GlobeCameraHelper` 的双实现开销
- 渲染循环省去每帧 `transitionState` 检查和双 Transform 同步，理论上性能应优于 legacy-hybrid
- 具体性能指标待灰度环境实测

## 6. 验收结论

当前状态：核心实现完成，单测通过，待灰度验证。

验收通过标准：

- 功能与回归用例全部通过
- strict 模式满足单链路不切换约束
- 性能指标达标
- 回滚演练通过

## 7. 遗留问题

- 是否长期保留 `legacy-hybrid` 作为隐藏开关待定
- 历史文档中有关内部过渡描述需统一清理
- 部分集成测试需增加运行时投影状态断言
