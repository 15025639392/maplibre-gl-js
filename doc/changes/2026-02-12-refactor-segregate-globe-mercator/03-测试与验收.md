# 03 测试与验收

## 1. 测试范围

- strict 模式下投影链路稳定性验证
- legacy-hybrid 与 strict 行为差异验证
- `setProjection` 显式切换行为验证
- Map 事件语义与触发时机验证
- 性能与稳定性回归验证

## 2. 复现步骤（Bug 场景可填）

现状问题复现（作为对照基线）：

1. 设置 `projection: 'globe'`
2. 在临界缩放区间连续缩放与拖拽
3. 观察渲染与交互细节在内部过渡点附近变化
4. 对照 strict 模式应保持同一投影链路行为

## 3. 用例设计

### 3.1 功能用例

- C-FUNC-01：`projection: 'globe'` 下 `activeProjection` 全程为 globe
- C-FUNC-02：`projection: 'mercator'` 下 `activeProjection` 全程为 mercator
- C-FUNC-03：调用 `setProjection('mercator')` 仅触发一次显式切换
- C-FUNC-04：调用 `setProjection('globe')` 后不再出现内部自动切换
- C-FUNC-05：strict 与 legacy-hybrid 由开关控制可切换

### 3.2 回归用例

- C-REG-01：地图缩放、拖拽、旋转基础交互回归
- C-REG-02：地形、标注、弹窗在两类投影下行为回归
- C-REG-03：样式切换与投影切换叠加场景回归
- C-REG-04：离屏渲染与拾取查询结果回归

### 3.3 边界与异常用例

- C-BND-01：高频缩放穿越历史临界区间（连续 200 次）
- C-BND-02：快速连续调用 `setProjection` 的时序一致性
- C-BND-03：地图 resize 与投影切换并发场景
- C-BND-04：WebGL context lost/restored 后投影状态一致性

## 4. 执行记录

| 用例ID | 描述 | 结果 | 备注 |
| --- | --- | --- | --- |
| C-FUNC-01 | globe 严格单链路验证 | pending | 实现后执行 |
| C-FUNC-02 | mercator 严格单链路验证 | pending | 实现后执行 |
| C-FUNC-03 | 显式切换事件验证 | pending | 实现后执行 |
| C-REG-01 | 基础交互回归 | pending | 实现后执行 |
| C-BND-01 | 临界区间高频缩放稳定性 | pending | 实现后执行 |

## 5. 性能验证（如适用）

目标阈值（strict 相对当前基线）：

- 渲染主循环耗时 P95：不高于基线 +3%
- 缩放交互卡顿率：不高于基线
- 内存占用峰值：不高于基线 +5%

对比维度：

- strict vs legacy-hybrid
- globe 场景 vs mercator 场景
- 普通缩放 vs 高频缩放场景

## 6. 验收结论

当前状态：待实现，未验收。

验收通过标准：

- 功能与回归用例全部通过
- strict 模式满足单链路不切换约束
- 性能指标达标
- 回滚演练通过

## 7. 遗留问题

- 是否长期保留 `legacy-hybrid` 作为隐藏开关待定
- 历史文档中有关内部过渡描述需统一清理
- 部分集成测试需增加运行时投影状态断言
