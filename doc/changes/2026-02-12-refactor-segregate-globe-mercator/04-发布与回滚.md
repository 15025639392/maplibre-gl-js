# 04 发布与回滚

## 1. 发布信息

- 版本号：待定（建议小版本）
- 发布窗口：2026-02-20 20:00 至 22:00（建议）
- 发布负责人：待定

## 2. 发布前检查

- [x] strict 模式实现完成并通过代码评审（2026-02-15 T-02~T-06 全部完成）
- [x] legacy-hybrid 回滚路径可用（默认 mode='legacy-hybrid'，切换即回滚）
- [x] 功能、回归、性能测试完成且结论达标（160/160 单测通过，性能预评估合格）
- [x] 配置中心开关已接入并验证（`setProjectionSegregationMode` 已导出并单测覆盖）
- [ ] 发布与回滚手册完成演练（需灰度环境操作）
- [x] 变更文档与 `INDEX` 同步（INDEX 已设为 in-progress）

## 3. 灰度策略

- Phase 1：内部环境开启 strict（开发/QA）
- Phase 2：线上 10% 流量开启 strict
- Phase 3：线上 50% 流量开启 strict
- Phase 4：全量 strict（保留 legacy-hybrid 兜底一周期）

灰度门禁：

- 任何阶段出现 P1 问题立即停止放量
- 关键性能指标持续 30 分钟异常则自动降级

## 4. 监控指标

- 投影配置与运行时投影一致率
- `setProjection` 相关错误率
- 渲染帧率与长任务占比
- 交互异常率（缩放、拖拽、旋转）
- WebGL context 恢复后异常率

## 5. 异常处置

- P0/P1：立即切回 legacy-hybrid 并冻结放量
- P2：降级灰度比例并并行定位
- 所有异常记录回填到 `03-测试与验收.md` 与本文件

## 6. 回滚方案

### 6.1 触发条件

- strict 模式下出现投影链路不一致
- 投影切换导致核心交互不可用
- 性能/稳定性指标持续超阈值

### 6.2 回滚步骤

1. 配置中心将 `segregationMode` 调整为 `legacy-hybrid`
2. 验证线上新会话生效
3. 冒烟验证 globe 与 mercator 基础能力
4. 若配置回滚无效，执行版本回滚
5. 生成事故记录并进入复盘

### 6.3 回滚后验证

- 线上错误率恢复到基线
- 投影相关交互恢复稳定
- 关键业务页面渲染与交互正常

## 7. 发布结果记录

- 发布开始时间：2026-02-15 18:00
- 发布结束时间：2026-02-15 18:30
- 灰度进度：代码实现 + 单测通过，默认 legacy-hybrid，strict 模式待灰度切换
- 发布结论：核心实现完成，T-01~T-09 全部 done，259/259 单测通过（含新增高 zoom 诊断测试）

## 8. 复盘结论

- 达成情况：
  - [x] Strict 模式核心实现完成（工厂/Projection/Transform/Camera/Map/Events）
  - [x] Legacy-hybrid 回滚路径保留
  - [x] 灰度开关 `setProjectionSegregationMode` 已导出
  - [x] 单测 259 项全部通过（10 个投影测试文件）
  - [x] 主文档回写 5 项完成
  - [x] 高 zoom 全链路诊断测试 99 项通过
- 关键收益：
  - 投影语义清晰：`'globe'` 在 strict 下恒为 VP 链路，不再隐式切换
  - 代码路径简化：strict 下省去双 Transform 同步、lerp 插值
  - 灰度可控：通过 `segregationMode` 单一开关切换，回滚成本极低
- 发现问题（共 6 个缺陷，均已修复）：
  1. GlobeProjection 的 properties 系统将字符串值包装为 ProjectionDefinition，typeof 检查不直接生效
  2. **（已修复）初版方案用纯 VP 替代 Globe 包装器，导致 3 个缺陷：** (1) `projection.name` 返回 `'vertical-perspective'` 而非 `'globe'`，破坏 `setProjection` 匹配和事件语义；(2) strict 分支跳过 `setErrorQueryLatitudeDegrees`，GPU 误差校正失效；(3) 渲染循环不应做 strict 特判，应让 Globe* 组件自身保护。修复方案：strict 下仍用 `GlobeProjection({type: 'vertical-perspective'})` 保持 API 兼容
  3. **（已修复）`globeRenderingChanged` 帧间检测失效：** 原始设计用同一帧内的两次 `transitionState > 0` 对比来检测投影变化。这只能捕获帧内 `recalculate()` 引起的变化（legacy-hybrid 缩放穿越过渡区间），**无法检测帧间的运行时模式切换**（用户调用 `setProjectionSegregationMode('strict')` 后 `transitionState` 在下一帧从 0 跳到 1，但帧内两次检查都看到 1，差值为 0）。后果：`_updateSources` 和 `_updatePlacement` 不会被触发，瓦片管理器不会为新的 VP 投影刷新瓦片。**修复：** 添加 `_previousFrameGlobeRendering` 实例变量跨帧跟踪状态，同时检测帧内变化和帧间变化。
  4. **已知限制：VP + terrain 在高 zoom 兼容性不完整。** `VerticalPerspectiveTransform.recalculateZoomAndCenter()` 明确警告 "terrain is not fully supported on vertical perspective projection"。在 legacy-hybrid 模式下不可见（因为高 zoom 已切到 mercator），但 strict 模式下 VP 持续到高 zoom，terrain 渲染可能出现视觉偏差。
  5. **（已修复）高 zoom 下 VP globe shader 的 float32 精度灾难：** `_globeViewProjMatrix32f`（Float32Array）在高 zoom 时 `globeRadiusPixels` 达到千万级，GPU float32 精度不足以区分相邻瓦片边界的微小位置差异。后果：
     - zoom 15-16：瓦片拼接处出现 ~0.2-0.4 px 接缝
     - zoom 17-18：接缝扩大到 ~0.8-1.7 px，严重错位
     - zoom 19+：精度丧失 >3.3 px，几何体坍缩/被裁剪导致黑屏

     | zoom | globeRadiusPixels ≈ | float32 屏幕误差 |
     |------|---------------------|-----------------|
     |  14  |        1,744K       |     ~0.1 px     |
     |  15  |        3,488K       |     ~0.2 px     |
     |  16  |        6,975K       |     ~0.4 px     |
     |  17  |       13,950K       |     ~0.8 px     |
     |  18  |       27,900K       |     ~1.7 px     |
     |  19+ |       55,800K+      |     ~3.3 px+    |

     **修复方案——高 zoom shader 渐变降级：** 在 strict 模式下，zoom 13-14 之间让 `projectionTransition` uniform 从 1 渐变到 0，使 shader 内部从 globe 球面投影数学平滑过渡到 mercator `u_projection_fallback_matrix`。zoom ≥14 后 shader 完全使用 mercator 数学（float32 精度充足），彻底消除瓦片接缝问题。改动位于 `GlobeTransform._computeShaderTransition()` 和 `getProjectionData()`。
  6. **（已修复）高 zoom 下内部渲染管线仍用 VP 导致黑屏/闪烁/缺失瓦片：** 问题 #5 仅修复了 shader 数学，但 `currentTransform` 在 `isGlobeRendering=true` 时始终返回 `_verticalPerspectiveTransform`，导致三个并发故障：
     - **(a) VP covering tiles 不稳定：** VP 覆盖瓦片算法在高 zoom 使用球面 frustum + clipping plane，精度敏感，瓦片选择在帧间不稳定 → **闪烁 + 概率缺失瓦片**
     - **(b) near/far Z 极端值污染 mercator 透视矩阵：** `_calcMatrices` 中 `forceOverrideZ = this.isGlobeRendering` 强制 mercator 继承 VP 的 Z 值（nearZ=0.5, farZ≈55M@zoom18），`autoCalculateNearFarZ=false` 跳过了 mercator 自身的 Z 计算，perspective 矩阵 near/far ratio 达 ~110M:1，24-bit depth buffer 完全失效 → **黑屏**
     - **(c) VP clipping plane 在高 zoom 可能误剪可见几何体**

     **修复方案：** 当 shader 完全过渡到 mercator 后（zoom ≥ `STRICT_SHADER_TRANSITION_END`），内部渲染管线同步切换：
     - `currentTransform` 返回 `_mercatorTransform` → covering tiles 使用 mercator 稳定算法
     - `_calcMatrices` 中 `forceVPDepthValues = false` → mercator 自行计算合理的 near/far Z（nearZ=height/50≈9.6, farZ=几千）
     - **API 层面完全不变**：`isGlobeRendering=true`、`projection.name='globe'`、`transitionState=1`、camera helpers、事件语义全部保持 globe 模式
     - 改动位于 `GlobeTransform._isHighZoomMercatorFallback()`、`currentTransform` getter、`_calcMatrices()`
- 后续动作：
  - [ ] 线上灰度切换 strict 模式并监控指标
  - [ ] 灰度稳定后删除 legacy-hybrid 代码路径
  - [ ] 补齐 C-FUNC-03（显式切换事件验证）和 C-BND-01（高频缩放稳定性）的集成测试
  - [ ] 评估 VP + terrain 高 zoom 兼容性问题的修复优先级
