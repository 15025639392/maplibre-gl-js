# 01 方案设计

## 1. 问题定义

现有 Globe 相机在极区附近使用“中心纬度 + 缩放”的约束模型，导致：

- 相机中心纬度受限，跨极时发生硬性钳制；
- 交互输入（drag/rotate/inertia）在接近 ±90° 时出现不连续；
- 以 `center.lng/center.lat` 为单一状态源时，跨极后的方向语义难以保持稳定。

本质是“球面旋转问题”被简化为“平面经纬约束问题”，在极点处出现数学奇异与体验断裂。

## 2. 约束条件

- 必须兼容现有 `Map` API（`jumpTo/easeTo/flyTo` 等）；
- 不能影响 Mercator 投影与非 Globe 业务；
- 需要保留高缩放下 Globe/Mercator 过渡逻辑；
- 默认行为需可控，支持灰度切换与快速回滚；
- 性能不得明显下降（交互帧率、事件处理耗时可量化）。

## 3. 方案概述

采用“姿态驱动 + 经纬归一化输出”的双层模型：

- 内核使用球面姿态（orientation）计算旋转与跨极连续运动；
- 对外仍输出兼容的 `center/bearing/pitch` 语义，必要时做归一化；
- 通过实验开关在 Globe 模式下启用 free-globe 逻辑，默认可配置为 `legacy`。

## 4. 详细设计

### 4.1 架构变更

新增 Globe 旋转子系统（建议）：

- `FreeGlobeController`：处理输入增量到姿态变换、跨极归一化、连续性保障；
- `GlobeCameraState`：统一维护内部姿态状态与外部兼容状态；
- `GlobeRotationNormalizer`：极点穿越时对经度/朝向进行规范化，避免突变。

调用链路建议：

`handler_manager -> camera update -> FreeGlobeController -> vertical_perspective_transform/globe_transform`

### 4.2 模块变更

- `src/geo/projection/vertical_perspective_transform.ts`
  - 将 `defaultConstrain` 从“纬度硬钳制”改为“跨极连续约束”；
  - 保留最大边界保护，但不阻断极点穿越。
- `src/geo/projection/globe_transform.ts`
  - 增加 free-globe 状态切换与转发；
  - 在 Globe/Mercator 过渡时维持状态一致。
- `src/ui/handler_manager.ts`
  - 交互增量进入统一旋转控制器；
  - 惯性动画跨极时保持角速度连续。
- 测试目录（新增/扩展）
  - Globe 跨极单测、交互集成测试、回归基线用例。

### 4.3 接口变更

对外接口（建议，实验态）：

```ts
type GlobeRotationMode = 'legacy' | 'free';

interface GlobeRotationOptions {
  mode?: GlobeRotationMode;
  poleCrossing?: 'clamp' | 'continuous';
}

map.setGlobeRotationOptions(options: GlobeRotationOptions): void;
map.getGlobeRotationOptions(): Required<GlobeRotationOptions>;
```

事件（建议）：

```ts
interface GlobePoleCrossEvent {
  type: 'globepolecross';
  from: 'north' | 'south';
  timestamp: number;
}
```

兼容策略：

- 若不设置新接口，默认沿用 `legacy`（零破坏）；
- 开启 `free` 后仅在 Globe 投影生效；
- 事件为新增，不改变现有事件结构。

### 4.4 数据结构变更

内部新增状态（示意）：

```ts
interface GlobeCameraState {
  // 内部姿态（用于连续旋转）
  orientationQuat: [number, number, number, number];
  // 对外兼容状态（用于既有 API 与事件）
  centerLngLat: {lng: number; lat: number};
  bearing: number;
  pitch: number;
}
```

说明：

- `orientationQuat` 作为真值源，避免极点附近欧拉角奇异；
- 对外状态通过归一化生成，保障老代码可读、可用。

## 5. 备选方案对比

- 方案 A：继续纬度钳制 + 局部补丁
  - 优点：改动小、风险低
  - 缺点：无法真正跨极连续，体验问题根因未解决
- 方案 B：姿态驱动（本方案）
  - 优点：可根治跨极不连续，扩展性最佳
  - 缺点：实现复杂度高，需完善测试体系
- 方案 C：引入完整飞行相机（含 roll）
  - 优点：能力最强
  - 缺点：范围过大，超出本次重构目标

结论：选择方案 B。

## 6. 向后兼容性评估

- API：新增可选接口，不破坏现有调用；
- 行为：默认 `legacy`，升级后无强制行为变更；
- 数据：无存量数据迁移需求；
- 渲染：不改样式规范，不改图层配置。

## 7. 风险与回滚点

主要风险：

- 极区连续旋转导致事件触发序列变化；
- Globe/Mercator 过渡时状态同步误差；
- 低端设备在高频旋转下 CPU 开销增加。

回滚点：

- 运行时开关关闭 free-globe，立即回退到 `legacy`；
- 保留旧约束路径与单测，确保可一键回滚；
- 发布期间监控指标异常触发自动降级。

## 8. 评审结论

- 当前状态：草稿待评审
- 评审关注点：
  - 跨极连续性数学正确性
  - 兼容性与事件稳定性
  - 性能回归阈值是否可接受
