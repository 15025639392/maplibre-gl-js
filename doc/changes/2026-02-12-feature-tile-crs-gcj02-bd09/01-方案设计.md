# 01 方案设计

## 1. 问题定义

当前引擎默认按 WGS84/WebMercator 语义处理坐标。接入 GCJ02/BD09 Raster 瓦片后，常见问题是“底图与业务数据（WGS84）整体错位”。

在首期实现中，我们聚焦 Raster：

- 先解决最常见、最刚需的“底图偏移”问题；
- 避免一次性改造 Vector/GeoJSON，降低风险与工期；
- 用最小闭环验证接口、性能和回滚机制。

## 2. 约束条件

- 本期仅支持 Raster source 的 CRS 兼容；
- 不修改 Map 主投影模型（仍基于现有 projection 体系）；
- 不改变默认行为：未配置时等价于当前版本；
- 不引入对业务不透明的全局隐式偏移；
- 中国境外默认不执行 GCJ/BD 偏移（可配置覆盖）。

## 3. 方案概述（Raster Only）

采用“Raster Source 级坐标系适配”：

- Map 主语义保持 WGS84；
- 仅对指定 Raster source 启用 CRS 适配；
- 在 Raster 请求/坐标换算边界做统一转换；
- Vector/GeoJSON 留到后续阶段，不在本期实现。

## 4. 详细设计

### 4.1 架构变更

新增 Raster 专用 CRS 适配组件：

- `CoordTransformEngine`：WGS84/GCJ02/BD09 算法实现；
- `RasterCrsRegistry`：维护 raster source 的 CRS 配置；
- `RasterTileCrsAdapter`：在 Raster tile URL/索引映射阶段应用转换。

首期调用链路：

`map.setRasterSourceCoordSystem -> RasterCrsRegistry -> RasterTileCrsAdapter -> RasterSource 请求链路`

### 4.2 模块变更（仅 Raster）

- 新增：`src/geo/coord_system/*`
  - `transform.ts`：WGS84/GCJ02/BD09 双向转换
  - `china_boundary.ts`：境内判定
  - `types.ts`：CRS 类型定义
- 改造：Raster 相关 source 模块（仅 raster/raster-dem 若确认纳入）
  - 读取 source CRS 配置
  - 在 tile 请求阶段应用坐标系映射
- Map API：只新增 Raster 维度配置接口（见 4.3）
- 缓存：tile cache key 增加 `crs` 维度，避免误复用

明确不改造（本期）：

- `GeoJSONSource` / `VectorTileSource` / 查询 API 坐标语义
- 样式表达式层的 CRS 扩展

### 4.3 接口变更（本期最终：仅 Raster）

```ts
type CoordSystem = 'wgs84' | 'gcj02' | 'bd09';

interface RasterSourceCoordSystemOptions {
  dataCrs: CoordSystem;
  tileCrs?: CoordSystem;        // 默认等于 dataCrs
  applyOutsideChina?: boolean;  // 默认 false
}

map.setRasterSourceCoordSystem(sourceId: string, options: RasterSourceCoordSystemOptions): Map;
map.getRasterSourceCoordSystem(sourceId: string): RasterSourceCoordSystemOptions | null;
```

参数约束：

- 仅当 `sourceId` 对应 Raster source 时允许设置；
- 非 Raster source 调用应抛出可读错误（或返回失败态，评审定）；
- `dataCrs` 缺失时报参数错误。

### 4.4 数据结构变更

```ts
interface RasterSourceCrsState {
  sourceId: string;
  dataCrs: 'wgs84' | 'gcj02' | 'bd09';
  tileCrs: 'wgs84' | 'gcj02' | 'bd09';
  applyOutsideChina: boolean;
  updatedAt: number;
}
```

缓存键建议：

`{sourceId}:{z}:{x}:{y}:{crs}`

## 5. 备选方案对比

- 方案 A：全源类型一次性支持（Raster+Vector+GeoJSON）
  - 优点：能力完整
  - 缺点：风险高、周期长、回归面大
- 方案 B：仅 Raster 首期（本方案）
  - 优点：问题命中高、可快速交付、风险可控
  - 缺点：Vector/GeoJSON 需求需二期补齐
- 方案 C：业务侧各自转换
  - 优点：内核零改动
  - 缺点：重复建设，长期维护差

结论：采用方案 B。

## 6. 向后兼容性评估

- 未配置接口：行为与当前版本完全一致；
- 非 Raster source：不受本次变更影响；
- 存量样式：无需改动；
- 通过 feature flag 可全局关闭并回退 legacy 行为。

## 7. 风险与回滚点

主要风险：

- 算法误差导致局部区域对齐不足；
- CRS 缓存分片导致内存上升；
- 错误配置 sourceId 引发运行时异常。

回滚策略：

- 全局关闭 `rasterSourceCrsEnabled`；
- 关闭后走 legacy Raster 请求路径；
- 若问题持续，执行版本回滚。

## 8. 评审结论

- 当前状态：草稿待评审
- 评审重点：
  - Raster-only 范围边界是否清晰；
  - API 命名与错误语义是否可用；
  - 精度/性能阈值与回滚门槛是否合理。
