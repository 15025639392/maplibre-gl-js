# 04 发布与回滚

## 1. 发布信息（Raster Only）

- 版本号：待定（建议小版本）
- 发布窗口：2026-02-20 20:00 ~ 22:00（建议）
- 发布负责人：待定
- 发布范围：仅 Raster source CRS 适配能力（不含 Vector/GeoJSON）

## 2. 发布前检查（Raster-only 清单）

- [ ] `rasterSourceCrsEnabled` feature flag 已接入并可动态开关
- [ ] Raster API 已完成联调：`setRasterSourceCoordSystem/getRasterSourceCoordSystem`
- [ ] 非 Raster source 调用 Raster API 的错误语义已验证
- [ ] Raster-only 用例通过（功能/回归/边界）
- [ ] 精度阈值达标（城市校准点 <= 15m，核心点 <= 8m）
- [ ] 性能阈值达标（渲染 P95 <= +2%，请求成功率波动 <= 0.2pp）
- [ ] tile cache `crs` 维度生效且无异常缓存膨胀
- [ ] 回滚脚本与降级流程演练通过
- [ ] 变更文档与 `doc/changes/INDEX.md` 已同步

## 3. 灰度策略（Raster Only）

- Phase 1：内部环境全量开启（研发/QA）
- Phase 2：线上指定业务 10% 灰度（仅含 Raster 业务）
- Phase 3：扩大到 50% 灰度（仅含 Raster 业务）
- Phase 4：全量发布（保留开关一个发布周期）

灰度门禁：

- 发现 P1 问题（明显偏移/核心页不可用）立即停止放量
- 任一关键指标连续 30 分钟异常则自动降级

## 4. 监控指标（Raster 专项）

- Raster 瓦片请求成功率 / 失败率
- CRS 转换错误日志计数（参数错误、转换失败、source 类型不匹配）
- Raster 页面渲染帧率与长任务占比
- 关键城市校准点偏移抽样结果
- tile cache 命中率与内存占用趋势（含 `crs` 分片）

## 5. 异常处置

- P0/P1：立即关闭 `rasterSourceCrsEnabled`，回退 legacy Raster 路径
- P2：降低灰度比例并并行排查
- 若错误集中在特定 source：临时下线该 source 的 CRS 配置
- 所有异常需回填到 `03-测试与验收.md` 与本文件

## 6. 回滚方案

### 6.1 触发条件

- Raster 底图与业务要素出现大范围明显错位
- 非 Raster 业务受到影响（违反首期边界）
- CRS 相关异常导致核心 Raster 页面不可用
- 性能指标持续超阈值并影响交互体验

### 6.2 回滚步骤

1. 配置中心关闭 `rasterSourceCrsEnabled`
2. 清理/失效受影响的 Raster CRS 运行时配置（如有）
3. 验证新会话走 legacy Raster 请求路径
4. 冒烟验证：
   - Raster 场景对齐恢复到历史基线
   - 非 Raster 场景行为无变化
   - Raster API 对非 Raster source 仍返回预期错误
5. 若开关回滚无效，执行版本回滚
6. 记录事故并进入复盘

### 6.3 回滚后验证

- Raster 场景偏移恢复到历史基线范围
- 错误率、帧率、请求成功率回归正常区间
- 非 Raster 场景无新增回归

## 7. 发布结果记录

- 发布开始时间：待填写
- 发布结束时间：待填写
- 灰度比例轨迹：待填写
- 开关状态变更记录：待填写
- 发布结果结论：待填写

## 8. 复盘结论

- 是否达到 Raster-only 目标：待填写
- 核心收益：待填写
- 发现问题与根因：待填写
- 二期（Vector/GeoJSON）进入条件：待填写
- 后续行动项：待填写
