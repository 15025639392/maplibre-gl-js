# 06 向后兼容与发布策略

## 1. 目标

- 在二次开发演进中，保障存量业务最小改动；
- 将兼容风险前置到设计与评审阶段；
- 让发布具备灰度、回滚、可追溯能力。

## 2. 兼容性分层

### 2.1 API 兼容

- 公共导出 API（入口面）必须优先保持稳定；
- 破坏性变更必须提供迁移指引与适配层。

### 2.2 样式兼容

- 既有 style/schema 尽量可直接运行；
- 新能力通过可选字段扩展，不影响旧字段语义。

### 2.3 渲染兼容

- 渲染结果允许微小差异，但不允许功能性回归；
- 关键渲染场景需有回归快照测试。

## 3. 版本策略（建议）

- Patch：bugfix，无行为变化。
- Minor：非破坏性增强，可新增可选参数。
- Major：破坏性变更，必须附迁移指南与适配窗口。

## 4. 变更分级与流程

| 级别 | 示例 | 要求 |
| --- | --- | --- |
| L1 低风险 | 内部重构、无行为变化 | 单测 + 基准回归 |
| L2 中风险 | 新增可选能力 | 集成测试 + 兼容验证 |
| L3 高风险 | API 语义变化 | RFC + 迁移方案 + 灰度 |

## 5. 兼容治理机制

- 新增“兼容评审”检查点（设计评审前置）；
- 每个高风险变更必须有：
  - 影响面分析
  - 迁移路径
  - 监控指标
  - 回滚方案

## 6. 灰度发布策略

- 分批放量：5% -> 20% -> 50% -> 100%；
- 每个阶段至少观察 24h；
- 任一关键指标异常触发自动回滚。

关键观察指标：

- 初始化失败率
- 渲染异常率
- JS 错误率
- 交互卡顿率

## 7. 回滚策略

- 代码层：保留前一稳定版本 Tag；
- 配置层：特性开关可一键关闭；
- 数据层：兼容旧 schema，避免不可逆迁移。

## 8. 迁移文档要求

每个破坏性变更必须提供：

- Before/After 示例；
- 受影响 API 列表；
- 自动化迁移建议（若可行）；
- 最短迁移路径。

## 9. 关联文档

- 接口规范：`03-接口定义与扩展规范.md`
- 路线图：`07-开发路线图与里程碑.md`
- 执行模板：`09-执行模板与验收标准.md`
