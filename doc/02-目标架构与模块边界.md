# 02 目标架构与模块边界

## 1. 设计原则

- 单一职责：每个模块只解决一类核心问题。
- 显式依赖：禁止“跨层直接引用 + 隐式共享状态”。
- 先兼容再演进：优先内部解耦，保持外部 API 稳定。
- 可观测性：关键链路可测、可监控、可回归。

## 2. 目标架构（逻辑分层）

```text
+------------------------------------------------------+
|                    Extension SDK                     |
| (protocol/source/custom layer/overlay/plugin facade) |
+-----------------------------+------------------------+
                              |
+-----------------------------v------------------------+
|                      Runtime Core                    |
|   frame scheduling / invalidation / lifecycle hooks  |
+-----------------------------+------------------------+
                              |
         +--------------------+---------------------+
         |                                          |
+--------v---------+                      +---------v---------+
|   Style Engine   |                      |   Data Pipeline   |
| style diff/eval  |                      | source/tile/worker|
+--------+---------+                      +---------+---------+
         |                                          |
         +--------------------+---------------------+
                              |
+-----------------------------v------------------------+
|                     Render Engine                    |
| pass graph / shader / terrain / projection branches  |
+------------------------------------------------------+
```

## 3. 模块职责

### 3.1 Runtime Core

- 统一脏标记、帧调度、任务队列、生命周期信号。
- 对外暴露统一的 `invalidate/schedule/cancel` 能力。
- 负责“何时执行”，不负责“如何渲染”。

### 3.2 Style Engine

- 管理 style diff、layer/source 变更、表达式评估。
- 维护样式上下文和 worker 同步协议。
- 对 Data Pipeline 只输出“增量变化”，不直接做 IO。

### 3.3 Data Pipeline

- 负责 source 适配、tile 生命周期、worker 通信与结果回收。
- 提供“可渲染数据快照”给 Render Engine。
- 封装 feature-state/reload/dependency 处理。

### 3.4 Render Engine

- 执行 pass graph、program 选择、GPU 资源调度。
- 维护 terrain/globe 分支下的一致渲染语义。
- 仅消费渲染输入，不承担业务规则。

### 3.5 Extension SDK

- 暴露稳定扩展面（source/protocol/custom layer/overlay）。
- 统一插件生命周期、版本协商、错误语义。
- 提供向后兼容的 facade，屏蔽内部结构演进。

## 4. 依赖规则

- 允许：`Extension SDK -> Runtime Core/Style/Data`。
- 允许：`Runtime Core -> Style/Data/Render`（调度层依赖）。
- 允许：`Style <-> Data` 通过契约对象交互。
- 禁止：业务插件直接依赖 Render 内部实现。
- 禁止：跨层读写共享可变对象（需走接口）。

## 5. 渐进式拆分策略

### 阶段 A：抽接口不搬家

- 先在原目录中抽出接口与 Facade；
- 保持运行行为不变，降低回归风险。

### 阶段 B：搬迁实现

- 逐步将实现迁入新模块目录；
- 每次仅迁一个子域（如调度、tile、style diff）。

### 阶段 C：收敛依赖

- 删除临时适配层；
- 建立 lint 规则限制跨层导入。

## 6. 模块 Owner 建议

- Runtime Core：引擎负责人。
- Style Engine：样式/表达式负责人。
- Data Pipeline：数据源/worker 负责人。
- Render Engine：图形/性能负责人。
- Extension SDK：平台 API 负责人。

## 7. 架构验收标准

- 每个模块具备明确 public contract；
- 关键路径回归测试通过；
- 变更后新增代码遵守依赖规则；
- 文档与实现一致。

## 8. 关联文档

- 接口细节：`03-接口定义与扩展规范.md`
- 性能要求：`05-性能优化专项方案.md`
- 路线安排：`07-开发路线图与里程碑.md`

## 9. 严格投影分离架构（Strict Projection Segregation）

### 9.1 模块职责

通过引入 `projection_config.ts` 模块，实现了 Globe 与 Mercator 投影的彻底分离：

- **projection_config.ts**：管理投影分离模式配置（`legacy-hybrid` 或 `strict`）
- **projection_factory.ts**：在严格模式下，为 `projection: 'globe'` 创建纯 VerticalPerspective 管道（无内部 Mercator 回退）
- **globe_projection.ts**：在严格模式下，`transitionState` 固定为 1（无混合过渡）
- **globe_transform.ts**：在严格模式下，`_globeness` 固定为 1（无混合状态）
- **globe_camera_helper.ts**：在严格模式下，`useGlobeControls` 固定为 true

### 9.2 架构边界

- **严格模式**：Globe* 类仍然存在以支持 legacy-hybrid 模式，但在严格模式下被完全绕过
- **工厂模式**：`projection_factory.ts` 根据 `projectionSegregationMode` 创建单管道对象（Globe 或 Mercator），避免双管道同步开销
- **向后兼容**：保留 legacy-hybrid 模式作为默认值，确保零风险渐进式迁移
