# 03 接口定义与扩展规范

## 1. 目标

- 建立二次开发统一接口语言，减少“口头约定”；
- 将扩展点变成可测试契约；
- 降低内部重构对业务扩展的冲击。

## 2. 核心接口草案（TypeScript）

```ts
export type InvalidateReason = style | source | placement | custom;

export interface RuntimeKernel {
  invalidate(reason: InvalidateReason): void;
  schedule(task: (timeStamp: number) => void): number;
  cancel(taskId: number): void;
}

export interface StyleMutation {
  kind: string;
  payload: unknown;
}

export interface StyleEngine {
  apply(mutations: StyleMutation[]): void;
  evaluate(context: { zoom: number; now: number }): void;
  snapshot(): StyleSnapshot;
}

export interface StyleSnapshot {
  layers: string[];
  sources: string[];
  projection: string;
}

export interface SourceAdapter {
  readonly type: string;
  onAdd(ctx: SourceContext): Promise<void> | void;
  loadTile(req: TileRequest, signal: AbortSignal): Promise<TileResult | null>;
  reloadTile?(req: TileRequest, signal: AbortSignal): Promise<TileResult | null>;
  unloadTile?(tileId: string): Promise<void> | void;
  serialize(): Record<string, unknown>;
}

export interface OverlayController {
  setVisible(id: string, visible: boolean): void;
  setFilter(id: string, filter: unknown): void;
  setOpacity(id: string, opacity: number): void;
}
```

## 3. 事件契约

### 3.1 事件设计原则

- 事件名稳定，payload 可扩展；
- 事件粒度以“可消费”为准，避免噪声事件泛滥；
- 提供版本字段，便于兼容演进。

### 3.2 建议事件模型

```ts
interface EngineEvent<T = unknown> {
  type: string;
  version: 1;
  timestamp: number;
  traceId?: string;
  payload: T;
}
```

推荐事件：

- `runtime.frame.start/end`
- `style.updated`
- `source.tile.loaded/errored`
- `render.pass.completed`
- `extension.plugin.error`

## 4. 错误码与异常语义

建议按域分段：

- `RUNTIME_*`：调度层错误
- `STYLE_*`：样式与表达式错误
- `SOURCE_*`：source/tile/worker 错误
- `RENDER_*`：渲染与 GPU 错误
- `EXT_*`：扩展接口错误

最小字段：`code`、`message`、`retriable`、`details`。

## 5. 插件/扩展生命周期

```text
register -> init -> onAdd -> active -> onRemove -> dispose
```

约束：

- 插件必须幂等处理重复注册；
- 插件不得直接修改内部私有状态；
- 所有跨线程调用必须可取消（AbortSignal）。

## 6. API 版本化策略

- API Header：`x-sdk-version`。
- 破坏性变更：新主版本 + 适配层。
- 非破坏性扩展：仅新增字段/方法，不改语义。

## 7. 接口验收清单

- 每个接口有输入/输出类型定义；
- 每个公共方法有错误语义；
- 至少 1 个 happy path + 1 个 error path 测试；
- 文档示例可运行。

## 8. 关联文档

- 架构边界：`02-目标架构与模块边界.md`
- 兼容策略：`06-向后兼容与发布策略.md`
- 模板清单：`09-执行模板与验收标准.md`
